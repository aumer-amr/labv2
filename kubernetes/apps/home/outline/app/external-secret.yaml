---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: outline-external-secret
  namespace: home
spec:
  target:
    name: outline-secret
    deletionPolicy: Delete
    template:
      type: Opaque
      data:
        # App
        DATABASE_URL: postgresql://{{ .outline_pg_user }}:{{ .outline_pg_pass }}@postgres-rw.database.svc.cluster.local/outline
        AWS_ACCESS_KEY_ID: {{ .access_key_id }}
        AWS_SECRET_ACCESS_KEY: {{ .secret_access_key }}
        SECRET_KEY: "{{ .outline_secret_key }}"
        UTILS_SECRET: "{{ .outline_utils_key }}"
        SMTP_USERNAME: "{{ .outline_smtp_username }}"
        SMTP_PASSWORD: "{{ .outline_smtp_password }}"
        # Postgres Init
        INIT_POSTGRES_DBNAME: |-
          outline
        INIT_POSTGRES_HOST: |-
          postgres-rw.database.svc.cluster.local
        INIT_POSTGRES_USER: |-
          {{ .outline_pg_user }}
        INIT_POSTGRES_PASS: |-
          {{ .outline_pg_pass }}
        INIT_POSTGRES_SUPER_USER: |-
          {{ .pg_super_user }}
        INIT_POSTGRES_SUPER_PASS: |-
          {{ .pg_super_pass }}
  data:
    - secretKey: pg_super_user
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: b0f64f2d-7a43-4ac2-9b6d-b02e01525324
        property: username
    - secretKey: pg_super_pass
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: b0f64f2d-7a43-4ac2-9b6d-b02e01525324
        property: password
    - secretKey: outline_pg_user
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: b0f64f2d-7a43-4ac2-9b6d-b02e01525324
        property: outline_pg_user
    - secretKey: outline_pg_pass
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: b0f64f2d-7a43-4ac2-9b6d-b02e01525324
        property: outline_pg_pass
    - secretKey: access_key_id
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: <toset>
        property: access_key_id
    - secretKey: secret_access_key
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: <toset>
        property: secret_access_key
    - secretKey: outline_secret_key
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: <toset>
        property: outline_secret_key
    - secretKey: outline_utils_key
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: <toset>
        property: outline_utils_key
    - secretKey: outline_smtp_username
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: <toset>
        property: outline_smtp_username
    - secretKey: outline_smtp_password
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: <toset>
        property: outline_smtp_password
